# Data Model: Video Upload URL Generation

**Feature**: 001-i-want-to  
**Phase**: 1 (Design)  
**Date**: October 4, 2025

## Overview

This feature uses simple request/response models without persistent storage. All state is ephemeral and encoded in the presigned URLs generated by AWS S3.

## Entities

### 1. UploadURLRequest

**Purpose**: Client request to generate a presigned upload URL

**Fields**:
| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| `filename` | `str` | Required, non-empty | Original filename with extension (e.g., "video.mp4") |

**Validation Rules**:

- `filename` MUST contain a file extension (at least one dot)
- `filename` MUST NOT be empty or whitespace-only
- `filename` length SHOULD be reasonable (<256 characters)
- Extension is extracted from the last `.` onwards

**Python Model**:

```python
from pydantic import BaseModel, Field, field_validator

class UploadURLRequest(BaseModel):
    filename: str = Field(
        ...,
        description="Original filename with extension",
        examples=["video.mp4", "recording.mov"]
    )

    @field_validator('filename')
    @classmethod
    def validate_filename(cls, v: str) -> str:
        if not v or not v.strip():
            raise ValueError("filename cannot be empty")
        if '.' not in v:
            raise ValueError("filename must include extension")
        if len(v) > 255:
            raise ValueError("filename too long (max 255 chars)")
        return v.strip()
```

**Example Request**:

```json
{
  "filename": "my_video.mp4"
}
```

---

### 2. UploadURLResponse

**Purpose**: Server response containing presigned URL and metadata

**Fields**:
| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| `upload_url` | `str` | Required, valid URL | AWS S3 presigned URL for PUT operation |
| `s3_path` | `str` | Required, non-empty | S3 object key (e.g., "upload/uuid.mp4") |
| `expires_in` | `int` | Required, positive | Seconds until URL expires (e.g., 1800) |
| `expires_at` | `str` | Required, ISO 8601 | Absolute expiration timestamp (UTC) |

**Validation Rules**:

- `upload_url` MUST be a valid HTTPS URL
- `s3_path` MUST follow pattern: `{base_path}/{uuid}.{extension}`
- `expires_in` MUST be positive integer (typically 1800)
- `expires_at` MUST be valid ISO 8601 timestamp in UTC

**Python Model**:

```python
from datetime import datetime, timedelta
from pydantic import BaseModel, Field, HttpUrl

class UploadURLResponse(BaseModel):
    upload_url: str = Field(
        ...,
        description="Presigned S3 URL for video upload (PUT request)"
    )
    s3_path: str = Field(
        ...,
        description="S3 object key where video will be stored",
        examples=["upload/550e8400-e29b-41d4-a716-446655440000.mp4"]
    )
    expires_in: int = Field(
        ...,
        description="Seconds until URL expires",
        gt=0,
        examples=[1800]
    )
    expires_at: str = Field(
        ...,
        description="ISO 8601 timestamp when URL expires (UTC)",
        examples=["2025-10-04T12:30:00Z"]
    )

    @classmethod
    def create(
        cls,
        upload_url: str,
        s3_path: str,
        expires_in: int
    ) -> "UploadURLResponse":
        """Factory method to create response with calculated expiration"""
        expires_at = datetime.utcnow() + timedelta(seconds=expires_in)
        return cls(
            upload_url=upload_url,
            s3_path=s3_path,
            expires_in=expires_in,
            expires_at=expires_at.isoformat() + "Z"
        )
```

**Example Response**:

```json
{
  "upload_url": "https://bucket.s3.amazonaws.com/upload/550e8400-e29b-41d4-a716-446655440000.mp4?X-Amz-Algorithm=AWS4-HMAC-SHA256&...",
  "s3_path": "upload/550e8400-e29b-41d4-a716-446655440000.mp4",
  "expires_in": 1800,
  "expires_at": "2025-10-04T12:30:00Z"
}
```

---

### 3. ErrorResponse

**Purpose**: Standardized error response format

**Fields**:
| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| `detail` | `str` | Required | Human-readable error message |
| `error_code` | `str` | Optional | Machine-readable error code |

**Error Codes**:

- `INVALID_FILENAME`: Filename validation failed
- `S3_SERVICE_ERROR`: AWS S3 service unavailable
- `CONFIGURATION_ERROR`: Missing or invalid configuration

**Python Model**:

```python
from pydantic import BaseModel, Field

class ErrorResponse(BaseModel):
    detail: str = Field(..., description="Error message")
    error_code: str | None = Field(None, description="Error code")
```

**Example Error Response**:

```json
{
  "detail": "filename must include extension",
  "error_code": "INVALID_FILENAME"
}
```

---

## Configuration Model

### Settings

**Purpose**: Application configuration from environment variables

**Fields**:
| Field | Type | Default | Description |
|-------|------|---------|-------------|
| `aws_s3_bucket` | `str` | Required | S3 bucket name |
| `aws_region` | `str` | `"us-east-1"` | AWS region |
| `upload_url_expiration` | `int` | `1800` | URL expiration in seconds |
| `s3_base_path` | `str` | `"upload"` | Base path prefix in S3 |

**Python Model**:

```python
from pydantic_settings import BaseSettings

class Settings(BaseSettings):
    aws_s3_bucket: str
    aws_region: str = "us-east-1"
    upload_url_expiration: int = 1800
    s3_base_path: str = "upload"

    class Config:
        env_file = ".env"
        env_prefix = "APP_"
```

**Environment Variables**:

```bash
APP_AWS_S3_BUCKET=my-video-bucket
APP_AWS_REGION=us-east-1
APP_UPLOAD_URL_EXPIRATION=1800
APP_S3_BASE_PATH=upload
```

---

## Data Flow

```
┌──────────┐
│  Client  │
└────┬─────┘
     │ POST /upload
     │ {"filename": "video.mp4"}
     ▼
┌─────────────────┐
│  FastAPI App    │
│  - Validate     │
│  - Extract ext  │
│  - Generate UUID│
└────┬────────────┘
     │ generate_presigned_url()
     ▼
┌──────────────┐
│  boto3/S3    │
│  - Create URL│
│  - Sign      │
└────┬─────────┘
     │ Return presigned URL
     ▼
┌─────────────────┐
│  FastAPI App    │
│  - Format resp  │
└────┬────────────┘
     │ UploadURLResponse
     ▼
┌──────────┐
│  Client  │
│  PUT video → presigned URL → S3
└──────────┘
```

## State Management

**No Persistent State**: This service is stateless. Each request is independent.

**Ephemeral State**:

- UUID generated per request (not stored)
- S3 path constructed from UUID + extension
- Presigned URL contains all authorization (AWS signature)

**State Location**: All upload state is encoded in the presigned URL by AWS S3.

---

## Type Safety Notes

**Modern Python 3.12+ Syntax**:

- Use `str | None` instead of `Optional[str]`
- Use `list[str]` instead of `List[str]`
- Use `dict[str, str]` instead of `Dict[str, str]`
- All function signatures MUST include type hints

**Pydantic Validation**:

- Automatic validation on model instantiation
- Field-level validators for custom rules
- Serialization to JSON with `model_dump_json()`

---

## Testing Considerations

**Request Validation Tests**:

- Valid filename with extension → success
- Filename without extension → validation error
- Empty filename → validation error
- Very long filename → validation error

**Response Format Tests**:

- All required fields present
- `expires_at` is future timestamp
- `expires_in` matches expiration
- `s3_path` follows UUID pattern

**Integration Tests**:

- Mock boto3 S3 client
- Verify `generate_presigned_url` called with correct params
- Test error handling when S3 unavailable
